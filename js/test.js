/**
 * Created by Ben on 21/01/2016.
 */
function knuthfisheryates2(e){for(var t,n,i=e.length;--i;)n=~~(Math.random()*(i+1)),t=e[i],e[i]=e[n],e[n]=t;return e}var poiOpen=!1,isMobile=!1,setErr;Element.NativeEvents.animationstart=2,Element.NativeEvents.animationend=2,Element.implement({fadeDelayed:function(e,t,n){return this.startFadeDelayed.delay(t,this,[e,n])},startFadeDelayed:function(e,t){var n=this;e>0&&this.setStyle("visibility","visible");var i=new Fx.Tween(this,{duration:290});return i.start("opacity",e).chain(function(){return t?n.destroy():void(0==e&&n.setStyle("visibility","hidden"))}),this},toggleDelayed:function(e,t,n,i){return this.fade(e),this.fadeDelayed(t,n,i)},setValue:function(e){return"button"==this.get("tag")?this.set("html",e):this.setProperty("value",e)},removeStyle:function(e){var t=new RegExp("[~;\\s]"+e+".*?[;~]","i"),n=this.get("style")+";";this.set("style",n.replace(t,""))}});var myWebSocket=new Class({Implements:[Options],options:{onstart:function(){},process:function(){},onstop:function(){}},initialize:function(e){this.setOptions(e),this.socket=null},start:function(){if(!this.socket){var e="ws://212.91.15.204:9001",t=this;try{this.socket=new WebSocket(e),this.socket.onopen=function(e){t.options.onstart(e)},this.socket.onmessage=function(e){t.options.process(e)},this.socket.onclose=function(e){t.options.onstop(e)},this.socket.onerror=function(e){t.restart()}}catch(n){}}},stop:function(){this.socket&&(this.socket.close(),this.socket=null)},send:function(e){e||(e=1);try{this.socket.send(e)}catch(t){}},restart:function(e){e||(e=1e4),this.stop(),this.start.delay(e,this)}}),insertStatuses=function(e){var t,n=$("tweets"),i=n.getElements("> a"),o=Object.keys(i).sort();o.pop(),Object.each(e,function(s,r){var a=new Element('a.init[href="https://twitter.com/statuses/'+e[r].id+'"][target="_blank"]').set("html",'<img src="'+e[r].user.avatar+'" alt="'+e[r].user.name+'" /> @'+e[r].user.name).inject(n,"top");Object.getLength(i)>=5&&(t=o[o.length-1],i[t].destroy(),delete i[t],o.erase(t)),function(){a.removeClass("init")}.delay(100*r)})},insertTile=function(e){var t=e.file.replace(/\.png$/,""),n=$("d"+t);n&&Asset.image("img/tiles/"+e.file,{onLoad:function(){if(n.getElement("img.tile").setProperty("src","img/tiles/"+e.file).removeClass("dummy"),e.data)for(var t=0;t<e.data.length;t++)new Element('img.poi[src="img/'+e.data[t].icon+'"][alt="&#10022;"][data-img="'+e.data[t].img+'"][data-name="'+e.data[t].name+'"]').setStyles(e.data[t].coor).inject(n);n.setStyle("opacity",1)}})},showExistsingTiles=function(e){var t=e.getElements("img.tile:not(.dummy) !> div");t&&0!=t.length&&(t=knuthfisheryates2(t),t.each(function(e,t){(function(){e.setStyle("opacity",1)}).delay(30*t)}))},closePoi=function(){if(poiOpen){var e=$("poi");poiOpen=!1,e.removeClass("open"),function(){e.addClass("hidden")}.delay(300)}},detectWidthLevel=function(){var e,t=document.getElement("body").getStyle("z-index").toInt();switch(t){case 1:e=!1;break;case 2:e="1080";break;case 3:e="600";break;case 4:e="480";break;default:e=!1}return e};window.addEvent("click",function(e){poiOpen&&!e.target.hasClass("poi")&&closePoi()});var errorHandler=new Class({initialize:function(e){},addErr:function(e,t){var n=typeOf(e);if(null==e||!e||1==e.length||""==e)return this.setGenericErr(t);if("string"==n&&(e=$(e)||this.p.getElement("[name^="+e+"]")),!e)return this.setGenericErr(t);var i=(this.p||e.getParent(),e.getCoordinates()),o=e.getProperty("type"),s=e;"checkbox"==o||"radio"==o?(s=e.getParent(),i=s.getCoordinates()):s.addClass("errorBoder");var r=new Element("div.errorBox").setStyles({background:"url(img/err4.png) no-repeat 4px -11px",position:"absolute","z-index":150,opacity:0,"padding-left":20}).set("tween",{duration:200}).set("html","<div>"+t+"</div>").inject(document.getElement("body")),a=r.getSize(),l={left:i.left+i.width-10,top:i.top+i.height/2-a.y/2};return l.top<0&&(l.top=i.top+i.height,r.setStyle("background","url(img/err2.png) no-repeat 70% top")),r.addEvent("click",function(){this.fadeDelayed(0,0,!0)}),r.setStyles(l),r.tween("opacity",1),r},addErrs:function(e){var t,n=this;return Object.each(e,function(e,i){t=n.addErr(i,e)}),t},setParent:function(e){this.p=e},setGenericErr:function(e){var t=$("errorGeneric");return t||(t=new Element("div#errorGeneric.komunikat.error.icon").inject(this.p||document.getElement("body"),"before")),t.set("html",e),t},closeErrs:function(){var e=document.getElements("div.errorBox"),t=$("errorGeneric");document.getElements(".errorBorder").removeClass("errorBorder"),e.length>0&&e.destroy(),t&&t.destroy()}});window.addEvent("domready",function(){setErr=new errorHandler,window.addEvent("resize",function(){isMobile=detectWidthLevel()}),isMobile=detectWidthLevel();var e=$("tiles"),t=$("poi");showExistsingTiles(e),e.addEvent("click:relay(img.poi)",function(){poiOpen=!0;var e=t.getElements("img,p"),n=this.getCoordinates(),i=this;Asset.image("img/poi/"+this.getProperty("data-img"),{onLoad:function(){var o={};e[0].setProperty("src","img/poi/"+i.getProperty("data-img")),e[1].set("html",i.getProperty("data-name")),o="480"==isMobile?{left:0,top:window.getSize().y/2+window.getScroll().y-t.getSize().y/2}:{left:n.left+n.width,top:n.top-41},t.setStyles(o),t.addClass("open"),t.removeClass("hidden")}})}),t.addEvents({click:function(){isMobile&&closePoi()}});var n=new myWebSocket({onstart:function(e){},process:function(e){var t=JSON.decode(e.data);t&&(t.statuses&&Object.getLength(t.statuses)>0&&insertStatuses(t.statuses),t.tile&&insertTile(t.tile))},onstop:function(e){n.restart()}});n.start(),document.getElement("body").addEvent('submit:relay(form[action="ajax"])',function(e){if(e.stop(),!this.hasClass("doubleSubmit")){var t=this,n=this.getElement("button[type=submit]"),i=n.get("html");t.getElement('input[name="js"]')||new Element('input[type="hidden"][name="js"][value="1"]').inject(t),setErr.setParent(t),t.set("send",{onRequest:function(){n.setProperty("disabled","disabled").setValue('<img src="https://dockets.dyinglightgame.com/img/spinner.gif" alt="'+langText.loading+'" />'),setErr.closeErrs()},onSuccess:function(e){var e=JSON.decode(e);if(!e)return n.removeProperty("disabled").setValue(i),setErr.addErr("0",langText.def.noout);if(e.ok){switch(e.action){case"msg":n.removeProperty("disabled").setValue(i);var o=new Element("p.ok.icon.komunikat[html="+e.msg+"]").inject(t,"before");o.fadeDelayed(0,12e3,!0),new Fx.Scroll(window,{duration:1200,transition:"quint:in:out"}).toElement(o,"y"),n.removeProperty("disabled").setValue(i),e.reload&&function(){window.location.reload()}.delay(2e3);break;case"forward":window.location.href=e.url;break;case"test":n.removeProperty("disabled").setValue(i);break;case"reload":default:window.location.reload()}e.nr||t.reset()}else new Fx.Scroll(window,{duration:1200,transition:"quint:in:out"}).toElement(setErr.addErrs(e.err),"y"),n.removeProperty("disabled").setValue(i)}}).addClass("doubleSubmit")}this.send()});var i=$$(".tweetIntent");i&&i.length>0&&i.addEvent("click",function(e){e.stop();var t=window.getSize().x;t>450&&(t=450),window.open(this.getProperty("href"),"_blank","width="+t+",height=265")});var o=$("cookieMonster");o&&(o.getElement("span").addEvent("click",function(){Modernizr.sessionstorage&&sessionStorage.setItem("cookieMonster",1),o.setStyles({bottom:-(o.getSize().y+30),opacity:0})}),Modernizr.sessionstorage&&!sessionStorage.getItem("cookieMonster")||!Modernizr.sessionstorage?function(){o.setStyle("opacity",1)}.delay(700):o.destroy())});